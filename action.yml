name: "ADR 2.0 Agent Promotion"
description: "Promote AARs under docs/aar/ to ADRs under docs/adr/, update index.json (agent-friendly)."
inputs:
  openai_api_key:
    description: "OpenAI API key"
    required: true
  openai_model:
    description: "OpenAI model name"
    required: false
    default: "gpt-5.1"
  github_token:
    description: "GitHub token for creating PRs (PAT recommended; GITHUB_TOKEN may be insufficient in some orgs)"
    required: true
  pr_branch:
    description: "Branch name for ADR auto-PR"
    required: false
    default: "adr/auto-update"
  pr_title:
    description: "PR title for ADR updates"
    required: false
    default: "chore: ADR auto-update"
  pr_body:
    description: "PR body for ADR updates"
    required: false
    default: "Automated ADR updates generated from AARs."
  pr_base:
    description: "Base branch for the PR (optional; defaults to repo default)"
    required: false
  language:
    description: "Language to generate ADRs (e.g., en, ko); default en"
    required: false
    default: "en"
runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      shell: bash
      run: |
        pip install --upgrade pip
        pip install -r "$GITHUB_ACTION_PATH/requirements.txt"

    - name: Generate ADRs from AARs
      shell: bash
      env:
        OPENAI_API_KEY: ${{ inputs.openai_api_key }}
        OPENAI_MODEL: ${{ inputs.openai_model }}
        ADR2_REPO_ROOT: ${{ github.workspace }}
        ADR2_LANGUAGE: ${{ inputs.language }}
      run: python "$GITHUB_ACTION_PATH/scripts/adr2_agent_action.py"

    - name: Show ADR index
      if: always()
      shell: bash
      run: test -f docs/adr/index.json && cat docs/adr/index.json || echo "index.json not created"

    - name: Create PR if changes
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ inputs.github_token || github.token }}
        commit-message: ${{ inputs.pr_title }}
        branch: ${{ inputs.pr_branch }}
        title: ${{ inputs.pr_title }}
        body: ${{ inputs.pr_body }}
        base: ${{ inputs.pr_base }}
        delete-branch: true
        add-paths: |
          docs/**
